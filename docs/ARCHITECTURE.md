# 伟盛酒业店铺展示系统架构文档（重构版）

## 1. 文档信息

| 项目 | 内容 |
|---|---|
| 文档名称 | 店铺展示系统架构文档 |
| 文档路径 | `docs/ARCHITECTURE.md` |
| 适用仓库 | `family-business` |
| 当前线上地址 | <https://llkongs.github.io/family-business/> |
| 文档版本 | v2.1 |
| 最近更新 | 2026-02-07 |
| 文档目标读者 | 开发模型、维护人员、部署运维人员 |

---

## 2. 项目背景与目标

### 2.1 背景

本系统用于门店内 55 寸竖屏（9:16，4K）无人值守播放，展示内容包括：

1. 顶部门店信息：店名、联系电话、二维码。
2. 中部视频轮播：横向 16:9 视频在竖屏内播放。
3. 下部图片区轮播：品牌宣传图、活动图、商品图，并承载右下角产品 CTA。
4. 产品菜单页：分类浏览和商品详情展示。

系统采用静态部署（GitHub Pages），内容由飞书多维表格维护，通过本地 Mac mini 上的同步服务定时拉取并推送到 GitHub。

### 2.2 业务目标

1. 展示稳定：支持 24x7 连续运行，出现异常可自动恢复。
2. 内容可运营：非开发人员可在飞书改内容，定时自动上屏。
3. 运维可控：同步失败可诊断，页面故障可快速恢复。
4. 成本可控：无需额外服务器，依赖 GitHub Pages + 本地定时任务。

### 2.3 非目标（当前阶段）

1. 非真正权限系统：不提供账号体系、RBAC、后端鉴权。
2. 非实时更新：不要求秒级同步，按分钟级/小时级同步即可。
3. 非交易系统：不处理下单、支付、库存扣减。
4. 非多租户平台：当前仅面向单门店部署。

---

## 3. 当前系统快照（As-Is）

### 3.1 前端技术

- TypeScript + Vite
- 原生 CSS
- hls.js（非 Safari）+ Safari 原生 HLS
- 单页应用，页面状态由 `main.ts` 管理

### 3.2 数据来源

- 飞书多维表格 5 张表：门店信息、媒体、品牌、展示分类、产品
- 同步工具：`tools/bitable-sync`（Rust）
- 产出文件：
  - `src/data/mockData.ts`
  - `src/data/productDatabase.json`
  - `public/videos/**`（HLS 分片）

### 3.3 部署链路

1. 本地执行 `bitable-sync sync`。
2. 生成/更新数据文件与媒体文件。
3. Git commit + push。
4. GitHub Actions 构建并部署到 GitHub Pages。
5. 展示屏浏览器打开固定 URL 进行播放。

### 3.4 当前主要问题（必须优先修复）

1. 前端密码是“弱门禁”，不能构成真实安全控制。
2. URL 拼接策略对绝对 URL 处理错误（二维码当前会坏）。
3. 飞书附件 URL 有时效性，不适合直接在静态页长期引用。
4. 播放器缺少完整错误恢复机制，长时间运行有卡死风险。
5. 同步脚本对“删除文件”提交不完整，仓库会积累历史垃圾文件。

---

## 4. 目标架构（To-Be）

### 4.1 架构原则

1. 静态优先：前端只消费静态资源与静态数据文件。
2. 本地可控：所有外部附件尽量落盘到 `public/` 后再引用。
3. 异常自愈：播放失败、脚本失败、浏览器异常均可自动恢复。
4. 可回滚：每次同步形成可追溯 Git 版本。
5. 可交接：任务和检查项标准化，任何模型可按清单执行。

### 4.2 逻辑架构图（文字版）

```text
[飞书多维表格]
    |
    | Feishu Open API
    v
[bitable-sync (Mac mini)]
    |- 拉取记录
    |- 下载附件（二维码/图片/视频）
    |- 视频转码为 HLS
    |- 生成 mockData.ts + productDatabase.json
    |- git add/commit/push
    v
[GitHub Repository]
    |
    | GitHub Actions
    v
[GitHub Pages 静态站点]
    |
    v
[门店展示屏浏览器(Kiosk)]
```

### 4.3 运行时页面分区（竖屏 9:16）

```text
┌──────────────────────────────┐
│ Header: 店铺名 + 电话 + QR   │
├──────────────────────────────┤
│ Video Area: 16:9 播放区      │
│ - 自动轮播                    │
│ - 错误恢复                    │
├──────────────────────────────┤
│ Image Area: 图片轮播主舞台     │
│ - 自动切换 + 导航点（底部居中）│
│ - 右下角悬浮 CTA: 查看产品详情 │
└──────────────────────────────┘
```

### 4.4 4K 竖屏精确尺寸建议（2160 x 3840）

> 设计原则：优先保证二维码 2 米可扫，再分配视频和图片展示空间。

| 区域 | 高度(px) | 占比 | 设计说明 |
|---|---:|---:|---|
| Header | 760 | 19.8% | 需要容纳大尺寸二维码 + 门店信息 |
| Video（16:9） | 1215 | 31.6% | 宽 2160 下的固定高度 `2160 x 9 / 16` |
| Image + CTA | 1865 | 48.6% | 图片轮播主展示区，同时承载 CTA 悬浮入口 |

### 4.5 Header 与二维码专项规范（2 米扫码）

1. Header 内部建议左右分栏：左侧信息区 62%，右侧二维码区 38%。
2. 二维码可视边长建议 `580px ~ 620px`（约 18.4cm ~ 19.7cm）。
3. 二维码最小边长不低于 `500px`（低于该值 2 米识别稳定性会明显下降）。
4. 二维码四周静区（白边）建议 `32px`，最低不低于 `24px`。
5. 二维码容器背景必须纯白，不叠加纹理、渐变、阴影蒙层。
6. Header 文本建议：店名 `96px ~ 110px`，电话 `72px ~ 84px`。

### 4.6 CTA 悬浮入口规范（替代底部按钮栏）

1. 去掉独立底部按钮栏，释放纵向空间给图片主视觉。
2. CTA 固定在图片区右下角，建议边距：右 `56px ~ 72px`，下 `56px ~ 72px`。
3. CTA 采用扩展 FAB（图标 + 文案），建议高度 `96px ~ 120px`，圆角胶囊。
4. CTA 样式建议：半透明深色底 + 高对比文字 + 轻微阴影，不使用强 pulse。
5. CTA 文案建议：`查看产品详情` 或 `扫码看产品详情`，避免长文案。
6. CTA 必须始终位于轮播图层之上，并保证触控命中区域不小于可视区域。

---
## 5. 目录与模块职责

## 5.1 前端目录

- `src/main.ts`
  - 应用入口
  - 页面切换（广告页/产品页）
  - 门禁逻辑（当前为前端弱门禁）
- `src/pages/AdDisplay.ts`
  - 视频播放（HLS）
  - 图片轮播
  - Header 显示
- `src/pages/ProductMenu.ts`
  - 分类导航
  - 商品卡片与详情弹窗
- `src/data/mockData.ts`
  - 门店信息、媒体、分类、商品（简化）
- `src/data/productDatabase.json`
  - 商品全量结构数据

## 5.2 同步工具目录

- `tools/bitable-sync/src/main.rs`
  - CLI 命令入口
- `tools/bitable-sync/src/sync.rs`
  - 同步主流程
- `tools/bitable-sync/src/video.rs`
  - 附件下载、视频转 HLS、媒体处理
- `tools/bitable-sync/src/transform/*`
  - 飞书记录转前端结构
- `tools/bitable-sync/src/output/*`
  - 写 TS/JSON 文件
- `tools/bitable-sync/src/git.rs`
  - 变更检测、提交、推送

---

## 6. 数据架构设计

### 6.1 飞书数据源（5 张表）

1. 门店信息表
2. 媒体表
3. 品牌表
4. 展示分类表
5. 产品表

### 6.2 数据落地策略（目标）

1. 文本型字段：直接写入 `mockData.ts` / `productDatabase.json`。
2. 附件型字段（二维码、图片、视频）：统一下载到仓库 `public/`。
3. 前端引用路径：统一相对路径（例如 `images/...`、`videos/...`）。
4. 禁止在前端长期直接使用飞书临时 URL。

### 6.3 输出文件定义

1. `src/data/mockData.ts`
  - 用于页面直接展示。
  - 包含 `storeInfo`、`mediaPlaylist`、`categories`、`products`。
2. `src/data/productDatabase.json`
  - 用于完整商品信息存档与扩展。
3. `public/videos/*`
  - HLS 播放列表与分片文件。
4. `public/images/*`
  - 二维码、品牌图、商品图等静态资源。

### 6.4 URL 规范（必须遵守）

1. 相对路径：加 `BASE_URL`。
2. 绝对 URL（`http://`、`https://`）：禁止拼接 `BASE_URL`。
3. 推荐实现：在同步阶段完成 URL 规范化，前端不做复杂判断。

---

## 7. 前端运行时架构

### 7.1 页面状态机

```text
[PasswordGate] --认证成功--> [AdDisplay] --点击按钮--> [ProductMenu]
       ^                                  |
       |----------------------------------|
                返回广告页
```

### 7.2 视频播放策略（目标）

1. 首选自动播放。
2. `play()` 失败时 `catch`，回退 `muted + retry`。
3. 监听 HLS 错误事件：
  - `NETWORK_ERROR`：重试加载。
  - `MEDIA_ERROR`：尝试 `recoverMediaError()`。
  - fatal：切下一条视频。
4. `ended` 事件与 watchdog 双保险。
5. `currentTime` 长时间不前进视为卡死，强制重载或切换。

### 7.3 图片轮播策略（目标）

1. 按每张图 `duration` 控制切换，默认值兜底。
2. 手动切换后重置定时器。
3. 图片列表为空时隐藏轮播区并调整视频区布局。

### 7.4 产品入口与 CTA 策略（目标）

1. 取消独立底部按钮栏，产品入口统一改为图片区右下角悬浮 CTA。
2. CTA 仅在存在可展示分类/商品时显示；无商品时自动隐藏。
3. CTA 点击后进入 `ProductMenu`，返回后保持广告页当前播放状态。
4. CTA 必须固定在图片区视觉安全区，避免遮挡核心商品图主体。
5. CTA 要求键盘和触控均可访问，且有明显 hover/focus/active 状态。

### 7.5 现代化视觉与动效策略（目标）

1. CTA 使用现代化扩展 FAB（icon + label）风格，不使用底栏大按钮。
2. 动效采用轻微上浮/阴影变化，避免持续 pulse 引发“故障感”。
3. 页面层次建议：背景氛围层 > 媒体层 > 信息层 > CTA 层。
4. 图片轮播转场建议优先淡入淡出，避免过快横向位移造成眩晕。

### 7.6 安全渲染策略（目标）

1. 避免直接 `innerHTML` 拼接未转义外部数据。
2. 优先使用 DOM API 创建节点并设置 `textContent`。
3. 如需模板渲染，必须统一 escape。
---

## 8. 同步服务架构

### 8.1 同步主流程（目标）

```text
读取配置
  -> 鉴权
  -> 并发读取 5 张表
  -> 字段解析与校验
  -> 附件下载（图片/二维码/视频）
  -> 视频转 HLS + 缓存命中判断
  -> 构建 mockData.ts / productDatabase.json
  -> 资源路径校验
  -> git add -A 指定目录
  -> commit + push
```

### 8.2 幂等与去重策略

1. 使用文件 token + size 判断视频是否需要重转码。
2. 输出文件内容相同则不提交。
3. 文件删除必须纳入 commit（避免历史残留）。

### 8.3 错误处理策略

1. API 错误：明确日志 + 退出非 0。
2. 字段缺失：按策略“跳过记录并告警”或“阻断同步”。
3. ffmpeg 失败：记录命令输出，标记本次同步失败。
4. Git push 失败：保留本地改动并告警。

### 8.4 配置管理策略

1. `.env.txt` 只存本地，不入库。
2. 必填配置启动时强校验。
3. `FAMILY_BUSINESS_REPO` 建议设为强制项，避免工作目录推断错误。

### 8.5 定时调度（Mac mini）

1. 推荐 `launchd` 定时执行同步命令。
2. 推荐频率：每 15 分钟或每 30 分钟。
3. 同步日志落地到固定文件并滚动归档。
4. 同步失败连续 N 次后触发人工告警（邮件/IM）。

---

## 9. 部署与运行架构

### 9.1 GitHub Actions（现状）

- 触发：`main` 分支 push
- 步骤：`npm ci` -> `npm run build` -> `deploy-pages`

### 9.2 建议补强

1. 在 CI 增加类型检查与最小化 smoke test。
2. 在部署前校验 `mockData.ts` 关键字段完整性。
3. 对大文件策略设上限（避免仓库无限增长）。

### 9.3 展示屏运行参数（Chrome Kiosk）

```bash
google-chrome \
  --kiosk \
  --autoplay-policy=no-user-gesture-required \
  --disable-infobars \
  --disable-session-crashed-bubble \
  --noerrdialogs \
  "https://llkongs.github.io/family-business/"
```

### 9.4 展示端守护建议

1. 浏览器崩溃自动重启。
2. 页面每 4-6 小时主动刷新一次。
3. 设备断电重启后自动拉起浏览器并进入全屏。

---

## 10. 安全架构与边界说明

### 10.1 当前边界

1. 当前“密码页”仅用于防误触，不是安全控制。
2. GitHub Pages 为公开静态站点，任何人可访问公开资源。

### 10.2 安全分级建议

1. 低成本方案（当前可行）
  - 使用随机长口令。
  - 改用 `localStorage` 保持认证状态。
  - 仅用于店内场景，不承载敏感数据。
2. 中成本方案
  - 接入 Cloudflare Access 或反向代理鉴权。
  - 页面访问需要设备身份或一次性 token。
3. 高安全方案
  - 迁移到带后端鉴权的平台，不再纯静态站点。

### 10.3 数据安全要求

1. 禁止将飞书密钥、token、私有 URL 写入仓库。
2. 禁止在页面展示成本价等敏感经营数据。
3. 所有输入字段视为不可信，输出到 HTML 前必须转义。

---

## 11. 稳定性与可观测性设计

### 11.1 故障类型

1. 前端播放故障：自动播放被拦截、HLS 错误、卡帧。
2. 同步故障：飞书 API 限流/鉴权失败、ffmpeg 失败、git push 失败。
3. 部署故障：CI 依赖安装失败、构建失败、Pages 发布失败。

### 11.2 可观测性最小闭环

1. 前端：
  - 记录视频切换、错误次数、最近一次恢复时间。
2. 同步服务：
  - 记录每次同步开始/结束时间、读取记录数、处理耗时、失败原因。
3. 部署：
  - 记录最近一次成功部署 commit SHA。

### 11.3 恢复策略

1. 前端故障：自动切片切换 -> 自动 reload -> 浏览器守护重启。
2. 同步故障：重试一次，仍失败则告警并保留上次可用数据。
3. 部署故障：不影响当前线上已发布版本，修复后再发布。

---

## 12. 性能与容量规划

### 12.1 当前容量

- 视频总量约 239MB（HLS）
- 仓库对象体积已明显受视频影响

### 12.2 风险

1. 视频迭代会导致 Git 历史膨胀。
2. 同步未正确处理删除时，仓库会越来越大。

### 12.3 优化策略（建议）

1. 短期：修复删除提交逻辑，定期清理无引用媒体。
2. 中期：将大视频迁移到对象存储/CDN，仅保留播放地址。
3. 长期：分离“代码仓库”和“媒体仓库”。

---

## 13. 里程碑与实施阶段

## Phase 0：止血修复（必须先做）

目标：解决当前会导致线上不可用或不可维护的问题。

1. 修复 URL 拼接策略。
2. 修复二维码/图片附件可长期访问问题。
3. 补齐播放器错误恢复与 watchdog。
4. 修复同步脚本提交删除文件问题。

## Phase 1：稳定运行

目标：支撑 24x7 无人值守。

1. 页面异常自动恢复。
2. 定时刷新机制。
3. launchd 定时同步 + 日志。
4. 同步失败告警闭环。

## Phase 2：运营可扩展

目标：让内容维护与发布更顺滑。

1. 媒体字段校验与内容规范。
2. 发布前检查脚本。
3. 可选接入对象存储。
4. 更细颗粒度的数据展示控制。

---

## 14. 详细 TODO 列表（可直接分派）

说明：

- `优先级`：P0 > P1 > P2。
- `状态`：`DONE` = 已完成，`TODO` = 待办。
- `验收标准` 为交付判断依据。

| ID | 优先级 | 模块 | 任务 | 交付物 | 验收标准 | 依赖 | 状态 |
|---|---|---|---|---|---|---|---|
| T001 | P0 | 同步工具 | 修复 `BASE_URL + 绝对URL` 拼接问题 | `ts_writer.rs` 逻辑更新 | `qrCodeUrl/media/image` 对绝对 URL 不再拼接 base | 无 | DONE |
| T002 | P0 | 同步工具 | 新增 URL 规范化函数 | 独立函数 + 单元测试 | 覆盖相对/绝对/空字符串场景 | T001 | DONE |
| T003 | P0 | 同步工具 | 二维码附件下载到 `public/images/qrcode.*` | 同步流程新增下载逻辑 | 二维码在 GitHub Pages 长期可访问 | 无 | DONE |
| T004 | P0 | 同步工具 | 商品主图附件下载到 `public/images/products/` | 图片下载器 + 路径映射 | 产品图不依赖飞书临时 URL | T003 | DONE |
| T005 | P0 | 同步工具 | 媒体图片附件下载到 `public/images/brands/` 或 `public/images/media/` | 媒体处理增强 | 媒体表仅填附件也能正常展示 | T003 | DONE |
| T006 | P0 | 前端 | `play()` 增加 `catch` 和回退策略 | `AdDisplay.ts` | 自动播放失败时可回退并继续播 | 无 | DONE |
| T007 | P0 | 前端 | 增加 HLS 错误监听和恢复策略 | `AdDisplay.ts` | 网络/媒体错误不会永久卡死 | T006 | DONE |
| T008 | P0 | 前端 | 增加视频 watchdog | `AdDisplay.ts` | `currentTime` 长时间不动会自动恢复 | T006 | DONE |
| T009 | P0 | 同步工具 | 修复删除文件未提交问题 | `git.rs` 或 `sync.rs` 更新 | 删除旧分片后 git 状态干净 | 无 | DONE |
| T010 | P0 | 安全 | 明确文档声明"前端密码非安全鉴权" | 文档与页面文案更新 | 评审不再误解为安全机制 | 无 | DONE |
| T011 | P1 | 前端 | 改造门禁持久化 `sessionStorage -> localStorage` | `main.ts` | 设备重启浏览器后无需重复输入 | 无 | DONE |
| T012 | P1 | 前端 | 移除底部按钮栏，改为图片区右下角悬浮 CTA | `AdDisplay.ts` + `style.css` | 无底栏占高；CTA 在图片区右下角且可点击 | 无 | DONE |
| T013 | P1 | 前端 | 全局异常兜底 `onerror/unhandledrejection` | `main.ts` | 未捕获异常可触发恢复逻辑 | 无 | DONE |
| T014 | P1 | 前端 | 增加定时自动刷新机制 | `main.ts` 或 `AdDisplay.ts` | 每 4-6 小时自动刷新一次 | T013 | DONE |
| T015 | P1 | 前端 | 渲染层避免直接拼接不可信 HTML | `AdDisplay.ts`/`ProductMenu.ts` | 外部数据不会直接进入 `innerHTML` | 无 | DONE |
| T016 | P1 | 前端 | 修正页面 title 与中文元信息 | `index.html` | 浏览器标题显示"伟盛酒业" | 无 | DONE |
| T017 | P1 | 前端 | 大屏可读性与扫码可达性调整（含二维码尺寸） | `style.css` | 3-5 米可读，2 米扫码通过 | 无 | DONE |
| T018 | P1 | 前端 | 现代化 CTA 样式与轻动效（替换 pulse） | `style.css` | CTA 视觉突出但无干扰性强闪烁 | 无 | DONE |
| T019 | P1 | 同步工具 | 启动前 `repo_root` 强校验 | `config.rs/sync.rs` | 错目录执行会直接失败并报错 | 无 | DONE |
| T020 | P1 | 同步工具 | 同步日志标准化（结构化关键字段） | `sync.rs` | 每次同步日志包含耗时/记录数/结果 | 无 | DONE |
| T021 | P1 | 运维 | 增加 launchd 定时任务配置 | `docs/` + plist 模板 | Mac mini 重启后自动定时同步 | 无 | TODO |
| T022 | P1 | 运维 | 同步失败告警脚本 | `tools/` 脚本 | 连续失败 N 次有通知 | T020 | TODO |
| T023 | P1 | CI | 增加部署前数据完整性检查 | workflow + script | 缺失关键字段时阻断发布 | 无 | DONE |
| T024 | P1 | CI | 增加最小前端 smoke test | workflow | 构建产物可加载关键页面 | 无 | DONE |
| T025 | P1 | 数据 | 统一字段字典与命名规范 | `docs/` | 飞书字段变更有映射文档 | 无 | TODO |
| T026 | P2 | 架构 | 媒体存储分层方案评估（Git vs 对象存储） | 评估文档 | 有容量上限与迁移结论 | 无 | TODO |
| T027 | P2 | 架构 | 页面配置化（Header/Video/Image 占比与 CTA 位置可调） | 配置结构 | 无需改代码可调布局比例与 CTA 偏移 | 无 | TODO |
| T028 | P2 | 前端 | 图片轮播支持淡入淡出与 CTA 自动避让 | `AdDisplay.ts/style.css` | 可配置切换动画且 CTA 不遮挡关键信息 | 无 | TODO |
| T029 | P2 | 前端 | 产品页交互增强（返回超时自动回广告） | `ProductMenu.ts` | 无操作超时自动返回广告页 | 无 | TODO |
| T030 | P2 | 数据 | 商品字段扩展（条码/规格校验） | parser + schema | 异常数据能在同步期被识别 | T025 | TODO |
| T031 | P2 | 文档 | 补充故障案例与处理记录模板 | `docs/` | 故障复盘模板可直接使用 | 无 | TODO |
| T032 | P2 | 运维 | 增加仓库体积巡检脚本 | `tools/` | 超阈值自动提示清理 | 无 | TODO |
| T033 | P2 | 安全 | 评估接入 Cloudflare Access | 方案文档 | 给出成本、复杂度、收益结论 | 无 | TODO |
| T034 | P2 | 质量 | 补充 bitable-sync 单元测试 | Rust tests | 核心转换逻辑覆盖率提升 | 无 | TODO |
| T035 | P2 | 质量 | 前端 e2e 回归脚本（可选） | 测试脚本 | 视频切换/图片切换/页面跳转可自动验收 | 无 | TODO |
| T036 | P1 | 同步工具 | 飞书标语表同步到前端 ticker | Slogan 模型 + 同步 + ts_writer | 飞书修改标语后同步即可更新网页滚动文字 | 无 | DONE |

---

## 15. 分批执行建议（给其他模型）

### 15.1 第一批（必须先做，建议一次 PR）

1. T001-T010。
2. 完成后先在本地跑通构建与基础播放。
3. 再上线到 GitHub Pages 验证。

### 15.2 第二批（稳定性增强）

1. T011-T025。
2. 建立“同步可观测 + 发布前检查”闭环。

### 15.3 第三批（扩展优化）

1. T026-T035。
2. 根据门店反馈做体验与架构优化。

---

## 16. 开发 Checklist（编码完成前）

### 16.1 前端代码 Checklist

- [ ] 视频 `play()` 已做 `catch` 回退。
- [ ] HLS `ERROR` 事件有完整处理。
- [ ] watchdog 可检测卡帧并恢复。
- [ ] 页面已移除独立底部按钮栏，CTA 悬浮在图片区右下角。
- [ ] CTA 的可视层级与点击命中区域在轮播上始终可用。
- [ ] Header 二维码尺寸与静区符合 2 米扫码设计值。
- [ ] 无商品数据时入口按钮隐藏。
- [ ] 动态内容未直接无转义插入 `innerHTML`。
- [ ] 页面标题和店铺文案为中文业务名。
- [ ] 大屏可读性已按实际距离测试。

### 16.2 同步工具 Checklist

- [ ] URL 规范化逻辑已覆盖绝对/相对路径。
- [ ] 附件下载器支持二维码、图片、视频。
- [ ] 视频缓存命中逻辑正常。
- [ ] 删除旧媒体文件可正确提交到 Git。
- [ ] 同步失败返回码非 0，日志包含原因。
- [ ] `repo_root` 校验明确，不依赖模糊推断。

### 16.3 CI Checklist

- [ ] `npm ci`、`npm run build` 稳定通过。
- [ ] 数据完整性检查通过。
- [ ] smoke test 通过。
- [ ] deploy job 成功发布到 Pages。

---

## 17. 上线前 Checklist（Pre-Launch）

### 17.1 数据与资源

- [ ] 门店名、电话、二维码显示正确。
- [ ] 二维码可视边长达到设计值（建议 580px ~ 620px，最低不低于 500px）。
- [ ] 二维码静区白边满足最低 24px，建议 32px。
- [ ] 至少 1 个视频可正常循环播放。
- [ ] 至少 1 张图片可正常轮播。
- [ ] 所有媒体链接均为可长期访问路径。
- [ ] 产品分类与商品数据符合预期。

### 17.2 展示端行为

- [ ] 冷启动后自动进入展示页。
- [ ] 播放中断时能自动恢复。
- [ ] 网络短时波动后可恢复。
- [ ] 页面无独立底部按钮栏，CTA 位于图片区右下角且无遮挡。
- [ ] 2 米正向扫码与约 30 度侧向扫码均可在 2 秒内识别。
- [ ] 连续运行 8 小时无人工干预。
- [ ] 浏览器重启后无需重复复杂操作。

### 17.3 运维能力

- [ ] 定时同步任务已配置并验证执行。
- [ ] 日志文件路径与保留策略明确。
- [ ] 同步失败告警可触达维护人。
- [ ] 回滚流程已演练一次。

---

## 18. 回归测试 Checklist（每次发布）

- [ ] 进入页面后门禁逻辑符合预期。
- [ ] 广告页视频至少切换 2 次无异常。
- [ ] 图片轮播能自动切换与手动切换。
- [ ] 产品页可进入可返回。
- [ ] 商品弹窗可打开可关闭。
- [ ] 二维码图片加载成功。
- [ ] CTA 悬浮位置与动画符合设计规范（右下角、轻动效、无强闪烁）。
- [ ] 控制台无高频报错。
- [ ] 页面无明显布局错位。

---

## 19. 日常巡检 Checklist（运营）

### 19.1 每日巡检

- [ ] 屏幕正常亮屏与全屏展示。
- [ ] 视频正在播放且有切换。
- [ ] 图片正在轮播。
- [ ] 电话与二维码可见且正确。
- [ ] 同步日志当天至少成功 1 次。

### 19.2 每周巡检

- [ ] 仓库体积变化在可接受范围。
- [ ] 近 7 天同步失败次数统计。
- [ ] 近 7 天页面异常次数统计。
- [ ] 过期或无效媒体已清理。

### 19.3 每月巡检

- [ ] 依赖版本安全更新评估。
- [ ] 媒体存储策略是否需要升级。
- [ ] 关键故障复盘是否形成记录。

---

## 20. 故障应急 Checklist（值守）

### 20.1 页面黑屏或卡死

- [ ] 先刷新页面。
- [ ] 再重启浏览器。
- [ ] 再重启设备。
- [ ] 检查网络连接。
- [ ] 检查最近发布是否异常并回滚。

### 20.2 视频不播放

- [ ] 确认媒体列表有视频数据。
- [ ] 检查 m3u8/ts 资源可访问。
- [ ] 检查浏览器是否使用 kiosk 启动参数。
- [ ] 检查控制台 HLS 错误日志。
- [ ] 临时切换到下一视频或静态图兜底。

### 20.3 同步失败

- [ ] 检查飞书鉴权与 token。
- [ ] 检查 ffmpeg 可执行。
- [ ] 检查 Git push 权限与网络。
- [ ] 使用上一次成功版本继续展示。
- [ ] 修复后手动触发一次同步并确认。

---

## 21. 回滚策略

### 21.1 数据回滚

1. 找到最近一次成功 commit。
2. 回退 `src/data/*` 与 `public/*` 到该版本。
3. 推送并触发 Pages 重新部署。

### 21.2 代码回滚

1. 使用 GitHub 历史版本快速回滚。
2. 回滚后立即执行回归测试 Checklist。
3. 记录故障原因并补防回归任务。

---

## 22. 交接给其他模型的执行说明

### 22.1 建议执行顺序

1. 先做 T001-T010。
2. 每完成 2-3 个任务就提交一次小 PR。
3. 每个 PR 必须附本地验证结果。
4. 所有 P0 完成后再进入 P1/P2。

### 22.2 每个任务的最小交付格式

1. 变更文件列表。
2. 关键实现点（不超过 5 条）。
3. 验证命令与结果。
4. 风险与后续任务。

### 22.3 统一完成定义（Definition of Done）

1. 代码已提交并可构建。
2. 对应 Checklist 项勾选通过。
3. 对应验收标准全部满足。
4. 文档状态从 `TODO` 更新为 `DONE`。

---

## 23. 附录：常用命令

### 23.1 前端

```bash
npm ci
npm run build
npm run dev
```

### 23.2 同步工具（Rust）

```bash
cd tools/bitable-sync
cargo run -- check
cargo run -- sync --dry-run
cargo run -- sync --no-push
cargo run -- sync
```

### 23.3 运行展示端（Chrome）

```bash
google-chrome \
  --kiosk \
  --autoplay-policy=no-user-gesture-required \
  --disable-infobars \
  --disable-session-crashed-bubble \
  --noerrdialogs \
  "https://llkongs.github.io/family-business/"
```

---

## 24. 本次重构摘要

本版文档完成了以下重构：

1. 从“描述型文档”升级为“执行型文档”。
2. 明确了 As-Is 与 To-Be 的差异和优先级。
3. 提供了 35 项可分派 TODO（带验收标准）。
4. 提供了开发、上线、回归、巡检、应急全流程 Checklist。
5. 形成了可直接交给其他模型执行的统一交付规范。

